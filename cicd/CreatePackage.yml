##########################################################################
#                                                                        #
#               Create package and Publish artifact                      #
#                                                                        #
##########################################################################

- stage: "Build"
    displayName: "Build package"
    dependsOn: "CreateDB"
      
    jobs:

      ##########################################################################
      #       Job: Create package and artifact                                 #
      ##########################################################################
      
      - job:
        displayName: "Build database package"
        pool: 
          vmImage: 'windows-latest'
          
        steps:
          - task: PowerShell@2
            displayName: "Create database package"
            inputs:
              targetType: "inline"
              script: |
                # Get the connection string
                $connectionString = "$(azSQLServerName)" + ".database.windows.net"

                # Install module 
                Install-Module dbops -Force -Scope CurrentUser

                # Create the package
                $build = Invoke-DBOPackageCI -Path $(System.DefaultWorkingDirectory)\package\$(artifactName).zip -ScriptPath .\opsscripts -Version 1.0

                # Update the build number from DBOPackage
                Write-Host "##vso[build.updatebuildnumber]$($build.Version)"

                # Update the config
                Update-DBOConfig $(System.DefaultWorkingDirectory)\package\$(artifactName).zip -Configuration @{ SqlInstance = "$connectionString"; Database = "$(azSqlDatabaseName)"; }
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)\package\$(artifactName).zip'
              artifact: $(artifactName)
              publishLocation: "pipeline"
